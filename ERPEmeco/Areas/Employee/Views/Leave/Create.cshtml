@model VM.ViewModels.EmployeeLeaveVM
@{
    ViewBag.Title = "تسجيل إجازة موظف";
    Layout = "_Layout";
}

<div class="container-xxl flex-grow-1 container-p-y">

    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">الرئيسية / </span> تسجيل إجازة موظف
    </h4>

    @using (Html.BeginForm("Create", "Leave", new { area = "Employee" }, FormMethod.Post, null,new { @enctype = "multipart/form-data" }))
    {
        <div class="form-horizontal">
            @Html.HiddenFor(m => m.Id)
            <input type="hidden" id="LeaveBalanceID" name="LeaveBalanceID" />

            <!-- اختيار الموظف -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="control-label">الموظف</label>

                    <input class="form-control" list="datalistOptions" id="EmployeeOptions" placeholder="اختار موظف..." autocomplete="off" />
                    <input type="hidden" name="EmployeeId" id="EmployeeId" />

                    <datalist id="datalistOptions">
                        @foreach (var emp in ViewBag.EmployeeOptions as SelectList)
                        {
                            <option data-id="@emp.Value" value="@emp.Text"></option>
                        }
                    </datalist>
                </div>

                <div class="col-md-6">
                    <label class="control-label">نوع الإجازة</label>
                    @Html.DropDownListFor(m => m.LeaveTypeId,
                    (SelectList)ViewBag.LeaveTypes,
                                "-- اختر نوع الإجازة --",
                                new { @class = "form-control", id = "LeaveTypeId" })
            </div>
        </div>

        <!-- رصيد الإجازات -->
        <div class="row mt-4" id="DaysSection" style="display:none;">
            <div class="col-md-4">
                <label>إجمالي الإجازات</label>
                <input type="text" id="TotalDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المستخدم</label>
                <input type="text" id="UsedDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المتبقي</label>
                <input type="text" id="RemainingDays" class="form-control text-center" readonly />
            </div>
        </div>

        <!-- التواريخ -->
        <div class="row mt-4">
            <div class="col-md-4">
                @Html.LabelFor(m => m.StartDate)
                @Html.TextBoxFor(m => m.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "StartDate" })
            </div>

            <div class="col-md-4">
                @Html.LabelFor(m => m.EndDate)
                @Html.TextBoxFor(m => m.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "EndDate" })
            </div>

            <div class="col-md-4">
                <label>عدد أيام الإجازة</label>
                <input type="text" name="ActualDays" id="ActualDays" class="form-control text-center" readonly />
          @*       @Html.TextBoxFor(m => m.ActualDays, new { @class = "form-control", id = "ActualDays" }) *@
            </div>
        </div>

        <!-- خصم الرصيد -->
        <div class="row mt-4" id="DeductedSection" style="display:none;">
            <div class="col-md-4">
                <label>من الرصيد</label>
                <input type="text" id="DaysFromBalance" name="DaysFromBalance" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>خصم من المرتب</label>
                <input type="text" id="DeductedDays" name="DeductedDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المتبقي بعد الخصم</label>
                <input type="text" id="NewRemaining" class="form-control text-center" readonly />
            </div>
        </div>

        <!-- السبب -->
        <div class="row mt-4">
            <div class="col-md-12">
                @Html.LabelFor(m => m.Reason)
                @Html.TextAreaFor(m => m.Reason, new { @class = "form-control", rows = 3 })
            </div>
        </div>
        <div class="row mt-3" id="AttachmentSection" style="display:none;">
            <div class="col-md-6">
                <label class="control-label">ارفاق ملف (PDF / صورة)</label>
                <input type="file" name="AttachmentFile" id="AttachmentFile" class="form-control" />
            </div>
        </div>

        <!-- زر الحفظ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <button type="submit" id="btnSave" class="btn btn-primary" disabled>حفظ</button>
                <a href="@Url.Action("Index", "Leave", new { area = "Employee" })" class="btn btn-secondary">رجوع</a>
            </div>
        </div>
    </div>
        }
</div>

@section Scripts {


    <script>
        const startInput = document.getElementById("StartDate");
        const endInput = document.getElementById("EndDate");
        const actualDaysInput = document.getElementById("ActualDays");

        // StartDate يبدأ من بكرة
        startInput.min = new Date(Date.now() + 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];

        // عند تغيير تاريخ البداية
        startInput.addEventListener("change", function () {
            // EndDate لا يبدأ إلا من StartDate
            endInput.min = this.value;

            // لو نهاية أقل من بداية يتم تصحيحها
            if (endInput.value < this.value) {
                endInput.value = this.value;
            }

            calculateDays();
        });

        // عند تغيير تاريخ النهاية
        endInput.addEventListener("change", function () {
            calculateDays();
        });

        // دالة حساب عدد الأيام
        function calculateDays() {
            if (startInput.value && endInput.value) {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);

                // الفرق بالأيام
                const diffTime = end - start;
                const diffDays = diffTime / (1000 * 60 * 60 * 24) + 1; // +1 عشان يشمل اليومين

                if (diffDays > 0) {
                    actualDaysInput.value = diffDays;
                } else {
                    actualDaysInput.value = "";
                }
            }
        }
    </script>

    <script>

        $(document).ready(function () {

            // =====================================================
            // 1) اختيار الموظف → تحميل الرصيد
            // =====================================================
            $("#EmployeeOptions").on("input", function () {
                const input = $(this).val();
                const hidden = $("#EmployeeId");
                const options = $("#datalistOptions option");
                let selectedId = "";

                options.each(function () {
                    if ($(this).val() === input) {
                        selectedId = $(this).data("id");
                        return false;
                    }
                });

                hidden.val(selectedId);
                loadLeaveBalance();
            });

            // =====================================================
            // 2) تغيير نوع الإجازة
            // =====================================================
            $("#LeaveTypeId").change(function () {
                let type = $(this).val();

                // مرضي → ملف إلزامي
                if (type == "3") {
                    $("#AttachmentSection").show();
                } else {
                    $("#AttachmentSection").hide();
                    $("#AttachmentFile").val("");
                }

                // إجازات تحتاج رصيد
                if (type == "1" || type == "2") {
                    $("#DaysSection").show();
                } else {
                    $("#DaysSection").hide();
                }

                loadLeaveBalance();
            });

            function loadLeaveBalance() {
                let employeeId = $("#EmployeeId").val();
                let leaveTypeId = $("#LeaveTypeId").val();

                if (employeeId && leaveTypeId) {

                    $.ajax({
                        url: '/Employee/Leave/GetLeaveBalance',
                        type: 'GET',
                        data: { employeeId: employeeId, leaveTypeId: leaveTypeId },
                        success: function (data) {
                            if (data) {
                                $("#LeaveBalanceID").val(data.id);
                                $("#TotalDays").val(data.totalDays);
                                $("#UsedDays").val(data.usedDays);
                                $("#RemainingDays").val(data.remainingDays);
                            }
                        }
                    });
                }
            }

            // =====================================================
            // 3) تغيير التواريخ
            // =====================================================
             $("#StartDate, #EndDate").change(function () {
                 var leaveType = $("#LeaveTypeId").val();
            var remainingDayes=$("#RemainingDays").val();
                          if(remainingDayes==0 && (leaveType == "2" ||leaveType == "1") ){
                alert("❌ لا يمكن أن تاخذ الإجازة لعدم وجود رصيد كافي");
              }
              else {
               var startVal = $("#StartDate").val();
                  var endVal = $("#EndDate").val();

                  if (!startVal || !endVal) return;

                  var start = new Date(startVal);
                  var end = new Date(endVal);
                 

          if (!startVal || !endVal) return;



          // ❌ منع أي إجازة سنوية أو مرضية قبل اليوم
          var today = new Date();
          today.setHours(0,0,0,0); // تصفير الوقت
          start.setHours(0,0,0,0);

          if ((leaveType == "3" || leaveType == "5") && start < today) {
              alert("❌ لا يمكن أن تكون الإجازة السنوية أو المرضية قبل تاريخ اليوم");
              $("#StartDate").val("");
              $("#EndDate").val("");
              $("#btnSave").prop("disabled", true);
              return;
          }
                  // ❌ منع نهاية قبل البداية
                  if (end < start) {
                      alert("❌ تاريخ النهاية يجب أن يكون بعد البداية");
                      $("#EndDate").val("");
                      $("#btnSave").prop("disabled", true);
                      return;
                  }

                         // =====================================================
          // شرط الإجازة الاعتيادية
          // =====================================================
                 // =====================================================
          // شرط الإجازة الاعتيادية
          // =====================================================
              if (leaveType == "2") {

            let today = new Date();
            today.setHours(0, 0, 0, 0); // تصفير الوقت

            let start = new Date($("#StartDate").val());
            start.setHours(0, 0, 0, 0);

            // حساب الفرق بالأيام
            let diffDays = (start - today) / (1000 * 60 * 60 * 24);

            // ممنوع الإجازة اليوم أو قبله
            if (diffDays < 1) {
                alert("❌ الإجازة الاعتيادية يجب تقديمها قبل بدايتها على الأقل بيوم واحد.");
                $("#btnSave").prop("disabled", true);
                return;
            }

            // أي مدة قبلها مسموحة (1 يوم إلى ما لا نهاية)
            $("#btnSave").prop("disabled", false);
        }

                  // =====================================================
                  // شرط الإجازة السنوية
                  // =====================================================
  if (leaveType == "5") {
                            start.setHours(0,0,0,0);
            end.setHours(0,0,0,0);


                      let month = start.getMonth() + 1;

                      // ❌ مسموح فقط في 7 و 8
                      if (month != 7 && month != 8) {
                          alert("❌ الإجازة السنوية متاحة فقط في شهر 7 أو 8");
                          $("#btnSave").prop("disabled", true);
                          return;
                      }
                              var diff = Math.round((end - start) / (1000 * 3600 * 24)) + 1;

          if (diff != 5) {
              alert("❌ الإجازة السنوية يجب أن تكون 5 أيام فقط من الأحد إلى الخميس");
              $("#btnSave").prop("disabled", true);
              return;
          }

                      // ❌ يجب أن تكون 5 أيام
                      if (diff != 5) {
                          alert("❌ الإجازة السنوية يجب أن تكون 5 أيام فقط من الاحد الي الخميس");
                          $("#btnSave").prop("disabled", true);
                          return;
                      }

                      // ❌ يجب أن تكون من الأحد إلى الخميس
                      // الأحد = 0 — الخميس = 4
                      if (start.getDay() != 0 || end.getDay() != 4) {
                          alert("❌ الإجازة السنوية يجب أن تكون من الأحد إلى الخميس فقط");
                          $("#btnSave").prop("disabled", true);
                          return;
                      }
                  }

                  $("#btnSave").prop("disabled", false);

                  // حساب الأيام
                  calculateDays();
              } 
     

            });

            // =====================================================
            // حساب أيام الإجازة والخصم
            // =====================================================
            function calculateDays() {

                let start = new Date($("#StartDate").val());
                let end = new Date($("#EndDate").val());

                var diff = (end - start) / (1000 * 3600 * 24) + 1;
                $("#ActualDays").val(diff);

                let remaining = parseFloat($("#RemainingDays").val());

                if (remaining >= diff) {
                    $("#DaysFromBalance").val(diff);
                    $("#DeductedDays").val(0);
                    $("#NewRemaining").val(remaining - diff);
                } else {
                    $("#DaysFromBalance").val(remaining);
                    $("#DeductedDays").val(diff - remaining);
                    $("#NewRemaining").val(0);
                }
            }

            // =====================================================
            // 4) الملف إلزامي للإجازة المرضي
            // =====================================================
            $("#btnSave").click(function (e) {

                let leaveType = $("#LeaveTypeId").val();

                if (leaveType == "3") {
                    let file = $("#AttachmentFile").val();

                    if (!file) {
                        e.preventDefault();
                        alert("❌ يجب إرفاق ملف للإجازة المرضية (PDF أو صورة)");
                        return false;
                    }
                }

                      const actualDaysInput = document.getElementById("ActualDays");
          const remainingInput = document.getElementById("RemainingDays");

          
              const actual = parseInt(actualDaysInput.value) || 0;
              const remaining = parseInt(remainingInput.value) || 0;

              if (actual > remaining) {
                  alert("عدد أيام الإجازة لا يمكن أن يكون أكبر من المتبقي!");
                        return false;
              }
          
            });

        });

    </script>


}
