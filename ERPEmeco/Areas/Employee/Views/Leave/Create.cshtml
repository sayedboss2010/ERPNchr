@model VM.ViewModels.EmployeeLeaveVM
@{
    ViewBag.Title = "تسجيل إجازة موظف";
    Layout = "_Layout";
}

<div class="container-xxl flex-grow-1 container-p-y">

    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">الرئيسية / </span> تسجيل إجازة موظف
    </h4>

    @using (Html.BeginForm("Create", "Leave", new { area = "Employee" }, FormMethod.Post, null,new { @enctype = "multipart/form-data" }))
    {
        <div class="form-horizontal">
            @Html.HiddenFor(m => m.Id)
            <input type="hidden" id="LeaveBalanceID" name="LeaveBalanceID" />

            <!-- اختيار الموظف -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="control-label">الموظف</label>

                    <input class="form-control" list="datalistOptions" id="EmployeeOptions" placeholder="اختار موظف..." autocomplete="off" />
                    <input type="hidden" name="EmployeeId" id="EmployeeId" />

                    <datalist id="datalistOptions">
                        @foreach (var emp in ViewBag.EmployeeOptions as SelectList)
                        {
                            <option data-id="@emp.Value" value="@emp.Text"></option>
                        }
                    </datalist>
                </div>

                <div class="col-md-6">
                    <label class="control-label">نوع الإجازة</label>
                    @Html.DropDownListFor(m => m.LeaveTypeId,
                    (SelectList)ViewBag.LeaveTypes,
                                "-- اختر نوع الإجازة --",
                                new { @class = "form-control", id = "LeaveTypeId" })
            </div>
        </div>

        <!-- رصيد الإجازات -->
        <div class="row mt-4">
            <div class="col-md-4">
                <label>إجمالي الإجازات</label>
                <input type="text" id="TotalDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المستخدم</label>
                <input type="text" id="UsedDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المتبقي</label>
                <input type="text" id="RemainingDays" class="form-control text-center" readonly />
            </div>
        </div>

        <!-- التواريخ -->
        <div class="row mt-4">
            <div class="col-md-4">
                @Html.LabelFor(m => m.StartDate)
                @Html.TextBoxFor(m => m.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "StartDate" })
            </div>

            <div class="col-md-4">
                @Html.LabelFor(m => m.EndDate)
                @Html.TextBoxFor(m => m.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "EndDate" })
            </div>

            <div class="col-md-4">
                <label>عدد أيام الإجازة</label>
                <input type="text" name="ActualDays" id="ActualDays" class="form-control text-center" readonly />
          @*       @Html.TextBoxFor(m => m.ActualDays, new { @class = "form-control", id = "ActualDays" }) *@
            </div>
        </div>

        <!-- خصم الرصيد -->
        <div class="row mt-4">
            <div class="col-md-4">
                <label>من الرصيد</label>
                <input type="text" id="DaysFromBalance" name="DaysFromBalance" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>خصم من المرتب</label>
                <input type="text" id="DeductedDays" name="DeductedDays" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>المتبقي بعد الخصم</label>
                <input type="text" id="NewRemaining" class="form-control text-center" readonly />
            </div>
        </div>

        <!-- السبب -->
        <div class="row mt-4">
            <div class="col-md-12">
                @Html.LabelFor(m => m.Reason)
                @Html.TextAreaFor(m => m.Reason, new { @class = "form-control", rows = 3 })
            </div>
        </div>
        <div class="row mt-3" id="AttachmentSection" style="display:none;">
            <div class="col-md-6">
                <label class="control-label">ارفاق ملف (PDF / صورة)</label>
                <input type="file" name="AttachmentFile" id="AttachmentFile" class="form-control" />
            </div>
        </div>

        <!-- زر الحفظ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <button type="submit" id="btnSave" class="btn btn-primary" disabled>حفظ</button>
                <a href="@Url.Action("Index", "Leave", new { area = "Employee" })" class="btn btn-secondary">رجوع</a>
            </div>
        </div>
    </div>
        }
</div>

@section Scripts {

    <script>

        $(document).ready(function () {

            // ============================
            // 1) اختيار الموظف → جلب الرصيد
            // ============================
            $("#EmployeeOptions").on("input", function () {
                const input = $(this).val();
                const hidden = $("#EmployeeId");
                const options = $("#datalistOptions option");
                let selectedId = "";

                options.each(function () {
                    if ($(this).val() === input) {
                        selectedId = $(this).data("id");
                        return false;
                    }
                });

                hidden.val(selectedId);

                loadLeaveBalance();
            });

            // عند تغيير نوع الإجازة
            $("#LeaveTypeId").change(function () {
               let type = $(this).val();
                     if (type == "3") {   // مرضي
            $("#AttachmentSection").show();
        } else {
            $("#AttachmentSection").hide();
            $("#AttachmentFile").val("");
        }
                loadLeaveBalance();
            });

            function loadLeaveBalance() {
                let employeeId = $("#EmployeeId").val();
                let leaveTypeId = $("#LeaveTypeId").val();

                if (employeeId && leaveTypeId) {

                    $.ajax({
                        url: '/Employee/Leave/GetLeaveBalance',
                        type: 'GET',
                        data: { employeeId: employeeId, leaveTypeId: leaveTypeId },
                        success: function (data) {
                            if (data) {
                                $("#LeaveBalanceID").val(data.id);
                                $("#TotalDays").val(data.totalDays);
                                $("#UsedDays").val(data.usedDays);
                                $("#RemainingDays").val(data.remainingDays);
                            }
                        }
                    });
                }
            }

            // ============================
            // 2) التاريخ → حساب الأيام
            // ============================
                 $("#StartDate, #EndDate").change(function () {

            var startVal = $("#StartDate").val();
            var endVal = $("#EndDate").val();

            // لو أي واحد فاضي
            if (!startVal || !endVal) return;

            var start = new Date(startVal);
            var end = new Date(endVal);

            // ❌ منع تاريخ نهاية قبل البداية
            if (end < start) {
                alert("❌ تاريخ النهاية يجب أن يكون بعد تاريخ البداية");

                $("#EndDate").val(""); // تفريغ التاريخ الخطأ
                $("#ActualDays").val("");
                $("#DaysFromBalance").val("");
                $("#DeductedDays").val("");
                $("#NewRemaining").val("");

                $("#btnSave").prop("disabled", true);
                return;
            }

            // لو التاريخ صحيح → نسمح بالحفظ
            $("#btnSave").prop("disabled", false);

            var employeeId = $("#EmployeeId").val();

            // فحص التداخل مع إجازة سابقة
            $.post('/Employee/Leave/CheckLeaveDate',
                { employeeId: employeeId, startDate: startVal, endDate: endVal },
                function (response) {

                    if (response.hasConflict) {
                        alert(response.message);
                        $("#btnSave").prop("disabled", true);
                        return;
                    }

                    $("#btnSave").prop("disabled", false);

                    // حساب عدد الأيام
                    calculateDays();
                });
        });

            // الحسابات الخاصة بالأيام
            function calculateDays() {

                let start = new Date($("#StartDate").val());
                let end = new Date($("#EndDate").val());

                var diff = (end - start) / (1000 * 3600 * 24) + 1;
                $("#ActualDays").val(diff);

                let remaining = parseFloat($("#RemainingDays").val());

                if (remaining >= diff) {
                    $("#DaysFromBalance").val(diff);
                    $("#DeductedDays").val(0);
                    $("#NewRemaining").val(remaining - diff);
                } else {
                    $("#DaysFromBalance").val(remaining);
                    $("#DeductedDays").val(diff - remaining);
                    $("#NewRemaining").val(0);
                }
            }

        });
    </script>

}
